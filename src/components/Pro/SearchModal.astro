---
/**
 * SearchModal.astro
 * Pro版: Pagefindを使った全文検索モーダル
 *
 * - ヘッダーの検索アイコンから開く
 * - Cmd/Ctrl+K ショートカットに対応
 * - ESCで閉じる
 */
---

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true" aria-label="サイト内検索">
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

  <!-- Modal Content -->
  <div class="relative flex items-start justify-center pt-[10vh] px-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
      <!-- Header -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
        <span class="text-sm text-gray-500">検索</span>
        <div class="flex items-center gap-2">
          <kbd class="hidden sm:inline-block px-2 py-1 text-xs font-medium text-gray-500 bg-gray-100 rounded">ESC</kbd>
          <button
            id="search-close"
            class="p-1 text-gray-400 hover:text-gray-600 transition-colors"
            aria-label="閉じる"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Pagefind Search Container -->
      <div id="pagefind-container" class="p-4">
        <!-- Pagefind UIがここに挿入される -->
      </div>
    </div>
  </div>
</div>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />

<style>
  /* Pagefind UIのカスタマイズ */
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #2563eb;
    --pagefind-ui-text: #374151;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #e5e7eb;
    --pagefind-ui-tag: #eff6ff;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 12px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: inherit;
  }

  /* 検索入力のスタイル調整 */
  #pagefind-container :global(.pagefind-ui__search-input) {
    font-size: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
  }

  /* 検索結果のスタイル調整 */
  #pagefind-container :global(.pagefind-ui__results-area) {
    max-height: 60vh;
    overflow-y: auto;
    margin-top: 1rem;
  }

  #pagefind-container :global(.pagefind-ui__result) {
    padding: 1rem;
    border-radius: 0.75rem;
    margin-bottom: 0.5rem;
  }

  #pagefind-container :global(.pagefind-ui__result:hover) {
    background-color: #f9fafb;
  }

  #pagefind-container :global(.pagefind-ui__result-link) {
    font-weight: 600;
    color: var(--pagefind-ui-primary);
  }

  #pagefind-container :global(.pagefind-ui__result-excerpt) {
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.5;
  }

  /* クリアボタン */
  #pagefind-container :global(.pagefind-ui__search-clear) {
    right: 1rem;
  }
</style>

<script is:inline>
  // Pagefind UIの初期化
  (function() {
    var pagefindInitialized = false;

    async function initPagefind() {
      if (pagefindInitialized) return;

      try {
        // 動的にPagefind UIスクリプトを読み込む
        var script = document.createElement('script');
        script.src = '/pagefind/pagefind-ui.js';
        script.onload = function() {
          if (typeof PagefindUI !== 'undefined') {
            new PagefindUI({
              element: '#pagefind-container',
              showSubResults: true,
              showImages: false,
              translations: {
                placeholder: '記事を検索...',
                zero_results: '「[SEARCH_TERM]」に一致する記事が見つかりませんでした',
                many_results: '[COUNT]件の記事が見つかりました',
                one_result: '1件の記事が見つかりました',
                searching: '検索中...',
              },
            });

            pagefindInitialized = true;

            // 検索入力にフォーカス
            setTimeout(function() {
              var input = document.querySelector('.pagefind-ui__search-input');
              if (input) input.focus();
            }, 100);
          }
        };
        script.onerror = function() {
          showFallback();
        };
        document.head.appendChild(script);
      } catch (error) {
        console.warn('Pagefind not available (run npm run build first):', error);
        showFallback();
      }
    }

    function showFallback() {
      var container = document.getElementById('pagefind-container');
      if (container) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">' +
          '<p>検索機能は本番ビルド後に利用できます</p>' +
          '<p class="text-sm mt-2">npm run build を実行してください</p>' +
          '</div>';
      }
    }

    // モーダルの開閉
    var modal = document.getElementById('search-modal');
    var backdrop = document.getElementById('search-backdrop');
    var closeBtn = document.getElementById('search-close');

    function openSearchModal() {
      if (modal) modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      initPagefind();
    }

    function closeSearchModal() {
      if (modal) modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // イベントリスナー
    if (backdrop) backdrop.addEventListener('click', closeSearchModal);
    if (closeBtn) closeBtn.addEventListener('click', closeSearchModal);

    // ESCキーで閉じる
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        closeSearchModal();
      }
    });

    // Cmd/Ctrl+K で開く
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal && modal.classList.contains('hidden')) {
          openSearchModal();
        } else {
          closeSearchModal();
        }
      }
    });

    // グローバルに公開（検索ボタンから呼び出す用）
    window.openSearchModal = openSearchModal;
  })();
</script>
